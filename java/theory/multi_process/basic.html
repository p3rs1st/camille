<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>理论基础 | Never See</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="不见">
    
    <link rel="preload" href="/camille/assets/css/0.styles.ac02bd7f.css" as="style"><link rel="preload" href="/camille/assets/js/app.89cf657d.js" as="script"><link rel="preload" href="/camille/assets/js/2.c0d8e570.js" as="script"><link rel="preload" href="/camille/assets/js/1.b1971c90.js" as="script"><link rel="preload" href="/camille/assets/js/39.233eb667.js" as="script"><link rel="prefetch" href="/camille/assets/js/10.655a1089.js"><link rel="prefetch" href="/camille/assets/js/11.e879aba2.js"><link rel="prefetch" href="/camille/assets/js/12.3d71d70f.js"><link rel="prefetch" href="/camille/assets/js/13.b40e96b9.js"><link rel="prefetch" href="/camille/assets/js/14.a15c23f8.js"><link rel="prefetch" href="/camille/assets/js/15.086621a3.js"><link rel="prefetch" href="/camille/assets/js/16.38ad00d8.js"><link rel="prefetch" href="/camille/assets/js/17.7d9f6541.js"><link rel="prefetch" href="/camille/assets/js/18.58f20acb.js"><link rel="prefetch" href="/camille/assets/js/19.cf2cf075.js"><link rel="prefetch" href="/camille/assets/js/20.f36b6fbb.js"><link rel="prefetch" href="/camille/assets/js/21.d1e109e6.js"><link rel="prefetch" href="/camille/assets/js/22.e5e7d61e.js"><link rel="prefetch" href="/camille/assets/js/23.c0b72d40.js"><link rel="prefetch" href="/camille/assets/js/24.24755f5b.js"><link rel="prefetch" href="/camille/assets/js/25.e79f3b27.js"><link rel="prefetch" href="/camille/assets/js/26.a28b8735.js"><link rel="prefetch" href="/camille/assets/js/27.2019210c.js"><link rel="prefetch" href="/camille/assets/js/28.195e9507.js"><link rel="prefetch" href="/camille/assets/js/29.da9a1b36.js"><link rel="prefetch" href="/camille/assets/js/3.c9a6670a.js"><link rel="prefetch" href="/camille/assets/js/30.7e78e35a.js"><link rel="prefetch" href="/camille/assets/js/31.742a34b1.js"><link rel="prefetch" href="/camille/assets/js/32.c69a703e.js"><link rel="prefetch" href="/camille/assets/js/33.9a798fe0.js"><link rel="prefetch" href="/camille/assets/js/34.09ed62b4.js"><link rel="prefetch" href="/camille/assets/js/35.40c45f3a.js"><link rel="prefetch" href="/camille/assets/js/36.30460db4.js"><link rel="prefetch" href="/camille/assets/js/37.36129612.js"><link rel="prefetch" href="/camille/assets/js/38.84775c59.js"><link rel="prefetch" href="/camille/assets/js/4.51108671.js"><link rel="prefetch" href="/camille/assets/js/40.665ccab0.js"><link rel="prefetch" href="/camille/assets/js/41.8f5e492c.js"><link rel="prefetch" href="/camille/assets/js/42.bc9f0e34.js"><link rel="prefetch" href="/camille/assets/js/43.203e2859.js"><link rel="prefetch" href="/camille/assets/js/44.d6e345f5.js"><link rel="prefetch" href="/camille/assets/js/5.c5132282.js"><link rel="prefetch" href="/camille/assets/js/6.89d8cb10.js"><link rel="prefetch" href="/camille/assets/js/7.ee093510.js"><link rel="prefetch" href="/camille/assets/js/vendors~docsearch.3d49b2ab.js">
    <link rel="stylesheet" href="/camille/assets/css/0.styles.ac02bd7f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/camille/" class="home-link router-link-active"><!----> <span class="site-name">Never See</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/camille/tool/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/camille/always/network.html" class="nav-link">
  常用表
</a></div><div class="nav-item"><a href="/camille/basic/network.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/camille/database/mysql.html" class="nav-link">
  MySQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论知识
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camille/java/theory/basic/basic.html" class="nav-link">
  基础理论
</a></li><li class="dropdown-subitem"><a href="/camille/java/theory/multi_process/basic.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  多进程
</a></li><li class="dropdown-subitem"><a href="/camille/java/theory/jvm/basic.html" class="nav-link">
  JVM
</a></li></ul></li><li class="dropdown-item"><h4>
          SpringBoot
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camille/java/springboot/bug.html" class="nav-link">
  bugs
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/camille/framework/springcloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/camille/framework/dubbo/" class="nav-link">
  Dubbo
</a></li></ul></div></div><div class="nav-item"><a href="/camille/unorganized/" class="nav-link">
  待整理
</a></div><div class="nav-item"><a href="/camille/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/camille/system/" class="nav-link">
  系统安装
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/camille/tool/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/camille/always/network.html" class="nav-link">
  常用表
</a></div><div class="nav-item"><a href="/camille/basic/network.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/camille/database/mysql.html" class="nav-link">
  MySQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论知识
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camille/java/theory/basic/basic.html" class="nav-link">
  基础理论
</a></li><li class="dropdown-subitem"><a href="/camille/java/theory/multi_process/basic.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  多进程
</a></li><li class="dropdown-subitem"><a href="/camille/java/theory/jvm/basic.html" class="nav-link">
  JVM
</a></li></ul></li><li class="dropdown-item"><h4>
          SpringBoot
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/camille/java/springboot/bug.html" class="nav-link">
  bugs
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/camille/framework/springcloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/camille/framework/dubbo/" class="nav-link">
  Dubbo
</a></li></ul></div></div><div class="nav-item"><a href="/camille/unorganized/" class="nav-link">
  待整理
</a></div><div class="nav-item"><a href="/camille/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="/camille/system/" class="nav-link">
  系统安装
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础理论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/camille/java/theory/basic/basic.html" class="sidebar-link">基础</a></li><li><a href="/camille/java/theory/basic/mechanism.html" class="sidebar-link">机制</a></li><li><a href="/camille/java/theory/basic/collection.html" class="sidebar-link">集合框架</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/camille/java/theory/multi_process/basic.html" aria-current="page" class="active sidebar-link">理论基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#并发三要素" class="sidebar-link">并发三要素</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#happens-before-规则" class="sidebar-link">Happens-Before 规则</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#线程安全等级" class="sidebar-link">线程安全等级</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#线程安全的实现" class="sidebar-link">线程安全的实现</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#线程的实现" class="sidebar-link">线程的实现</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#线程基础使用" class="sidebar-link">线程基础使用</a></li><li class="sidebar-sub-header"><a href="/camille/java/theory/multi_process/basic.html#java锁" class="sidebar-link">Java锁</a></li></ul></li><li><a href="/camille/java/theory/multi_process/javalib.html" class="sidebar-link">java库</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/camille/java/theory/jvm/basic.html" class="sidebar-link">理论基础</a></li><li><a href="/camille/java/theory/jvm/gc.html" class="sidebar-link">GC</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="理论基础"><a href="#理论基础" class="header-anchor">#</a> 理论基础</h1> <p></p><div class="table-of-contents"><ul><li><a href="#并发三要素">并发三要素</a></li><li><a href="#happens-before-规则">Happens-Before 规则</a></li><li><a href="#线程安全等级">线程安全等级</a></li><li><a href="#线程安全的实现">线程安全的实现</a></li><li><a href="#线程的实现">线程的实现</a></li><li><a href="#线程基础使用">线程基础使用</a><ul><li><a href="#线程同步互斥">线程同步互斥</a></li></ul></li><li><a href="#java锁">Java锁</a></li></ul></div><p></p> <h2 id="并发三要素"><a href="#并发三要素" class="header-anchor">#</a> 并发三要素</h2> <ul><li><code>可见性</code>: CPU缓存, 不同线程对一个变量的修改其他线程不能马上看到, 而是先修改线程自身的缓存</li> <li><code>原子性</code>: 一行代码含有的多个操作无法保证绝对连续执行, 涉及地址多次操作(如<code>x = y, x++</code>)一般不保证原子性</li> <li><code>有序性</code>: 代码经JVM优化后会发生指令重排, 进而可能导致可见性问题</li></ul> <h2 id="happens-before-规则"><a href="#happens-before-规则" class="header-anchor">#</a> Happens-Before 规则</h2> <ul><li><code>单一线程原则</code>: 一个线程内, 程序前面操作先于后面操作</li> <li><code>管程锁定规则</code>: unlock先于对同一个锁的lock</li> <li><code>volatile变量规则</code>: volatile变量的写操作先于读操作</li> <li><code>线程启动规则</code>: Thread对象的start()先于该线程所有操作</li> <li><code>线程加入规则</code>: Thread对象的结束先于join()返回</li> <li><code>线程中断规则</code>: 线程interrupt()先于中断线程代码检测到中断事件</li> <li><code>对象终结规则</code>: 对象的初始化先于finalize()的开始</li> <li><code>传递性</code>: A先于B, B先于C, 则A先于C</li></ul> <h2 id="线程安全等级"><a href="#线程安全等级" class="header-anchor">#</a> 线程安全等级</h2> <ol><li><code>不可变</code>: 一定线程安全</li> <li><code>绝对线程安全</code>: 无论运行环境, 无需同步即可保证线程安全</li> <li><code>相对线程安全</code>: 对对象单独操作线程安全, 调用无需额外措施, 但是需要代码持续运行需要同步保证调用正确, 如Vector获取元素线程试图访问被删除元素会抛出异常导致无法继续</li> <li><code>线程兼容</code>: 对象本身不是线程安全, 但可以通过同步保证线程安全</li> <li><code>线程对立</code>: 无论是否同步都无法在多线程中使用</li></ol> <h2 id="线程安全的实现"><a href="#线程安全的实现" class="header-anchor">#</a> 线程安全的实现</h2> <ul><li>使用锁进行互斥同步(阻塞同步)</li> <li>非阻塞同步:
<ul><li><code>CAS</code>: 对内存V操作时, 只有当V的值等于A时才会修改为B</li> <li><code>AtomicInteger</code>: 使用CAS实现操作</li> <li><code>ABA</code>: CAS存在的问题, 一个变量被读取时是A, 经过多次修改又改回了A, 导致CAS认为其未发生变化, AtomicStampedReference解决(一般不影响线程安全)</li></ul></li> <li>无同步方案:
<ul><li><code>栈封闭</code>: 线程自己的栈内变量无线程安全问题</li> <li><code>线程本地存储</code>: 将线程共享数据的代码在同一线程中执行, 如一个Web请求对应一个服务器线程</li></ul></li></ul> <h2 id="线程的实现"><a href="#线程的实现" class="header-anchor">#</a> 线程的实现</h2> <ul><li>实现Runnable接口, 无返回值, 不能抛出异常</li> <li>实现Callable接口, 有返回值, 可抛出异常</li> <li>继承Thread类</li></ul> <h2 id="线程基础使用"><a href="#线程基础使用" class="header-anchor">#</a> 线程基础使用</h2> <ul><li><code>Thread::setDaemon()</code>: 设置守护线程, 守护线程为后台进程, 所有非守护进程结束时杀死守护线程</li> <li><code>Thread.yield()</code>: 声明线程已完成重要部分, 可让同优先级其他线程优先运行</li> <li><code>Thread::interrupt()</code>: 外部调用为中断进程, 内部调用(仅限于继承Thread用法)为判断进程是否中断</li></ul> <h3 id="线程同步互斥"><a href="#线程同步互斥" class="header-anchor">#</a> 线程同步互斥</h3> <ul><li><code>synchronized</code>: 同步一个代码块/方法/类/静态方法, JVM实现, 不可等待中断, 非公平锁</li> <li><code>ReentrantLock</code>: JDK实现, 可等待中断, 公平锁/非公平锁</li></ul> <hr> <ul><li><code>wait(), notify(), notifyAll()</code>: Object自带</li> <li><code>await(), signal(), signalAll()</code>: JUC实现的Condition, 在<code>lock()</code>和<code>unlock()</code>之间使用</li></ul> <h2 id="java锁"><a href="#java锁" class="header-anchor">#</a> Java锁</h2> <ul><li><code>乐观锁</code>: 不锁住同步资源, 适合读操作多, 如CAS</li> <li><code>悲观锁</code>: 锁住同步资源, 适合写操作多, 如AtomicInteger</li></ul> <hr> <ul><li><code>自旋锁</code>: 获取同步资源失败时, 不放弃CPU时间片, 通过自旋尝试获取锁, 能减少CPU切换和恢复现场产生的损耗</li> <li><code>自适应自旋锁</code>: 根据之前自旋获取锁的成功情况调整自旋次数策略</li></ul> <hr> <ul><li><code>公平锁</code>: 线程按申请锁的顺序执行, 线程不会饿死, 但吞吐效率低</li> <li><code>非公平锁</code>: 线程直接尝试获取锁, 新线程获取锁无需唤醒旧线程, 减少唤醒线程开销, 吞吐率高, 但线程可能饿死, 如synchroinzed</li></ul> <hr> <ul><li><code>可重入锁</code>: 同一线程外层方法获取锁后进入内层方法, 内层方法自动获取锁(如锁同一个对象或class), 如ReentrantLock, synchronized</li> <li><code>非可重入锁</code>: 如NonReentrantLock</li></ul> <hr> <ul><li><code>独享锁/排他锁</code>: 锁一次只能被一个线程持有, 不能加上其他任何类型锁</li> <li><code>共享锁</code>: 可被多个线程持有, 只能读取数据不能修改</li></ul> <p><strong>JVM锁优化</strong>:</p> <ul><li><code>锁消除</code>: 编译器将检测到不存在共享数据冲突的锁消除</li> <li><code>锁粗化</code>: 反复加锁的操作粗化到整个步骤加锁</li> <li><code>轻量级锁</code>: 用于大部分锁大部分时间处于无锁竞争状态的方案
<ol><li>在对象头<code>Object Header</code>中一部分存储对象自身的运行时数据<code>Mark Word</code>(<code>HashCode</code>, <code>GC Age</code>, <code>锁标记位</code>, <code>是否为偏向锁</code>), 另一部分存储指向方法区对象类型数据的指针<code>Klass Word</code></li> <li>锁标记位状态包含: 00轻量级锁, 01无锁, 10重量级锁</li> <li>若同步对象为01状态, 则执行当前线程时, 在当前线程栈帧中创建<code>Lock Record</code>, 存储同步对象的<code>Mark Word</code>, 并用CAS将同步对象的<code>Mark Word</code>修改为指向<code>Lock Record</code>的指针, 并将栈帧中存储<code>Mark Word</code>的状态改为00</li> <li>如果CAS失败, 若<code>Mark Word</code>指向当前栈帧, 说明可以继续直接使用, 否则说明被其他线程抢占, 此时通过修改锁标记位为10将锁膨胀为重量级锁</li></ol></li> <li><code>偏向锁</code>: 某一线程会更多的获取锁, 让该线程进出同步块无需CAS操作, 只需测试<code>Mark Word</code>是否存在该线程的偏向锁, 出现竞争时释放偏向锁并暂停偏向线程</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">2022/11/1 10:20:27</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/camille/java/theory/basic/collection.html" class="prev">
        集合框架
      </a></span> <span class="next"><a href="/camille/java/theory/multi_process/javalib.html">
        java库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/camille/assets/js/app.89cf657d.js" defer></script><script src="/camille/assets/js/2.c0d8e570.js" defer></script><script src="/camille/assets/js/1.b1971c90.js" defer></script><script src="/camille/assets/js/39.233eb667.js" defer></script>
  </body>
</html>
